<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ©ãƒ³ãƒ—ãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</title>
    <style>
        :root {
            --bg-color: #2c2c2c;
            --text-color: #f0f0f0;
            --container-bg: #383838;
            --border-color: #555;
            --accent-color: #5cb85c;
            --accent-hover: #4cae4c;
        }
        body {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s;
        }
        .screen {
            display: none;
            width: 100%;
            max-width: 640px;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        .screen.active {
            display: block;
        }
        h1, h2 {
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .menu-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .btn, .menu-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.2s;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }
        .btn:hover, .menu-btn:hover {
            background-color: var(--accent-hover);
        }
        .btn-secondary {
            background-color: #777;
        }
        .btn-secondary:hover {
            background-color: #666;
        }

        /* Game Screen Specific Styles */
        #player-stats {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #444;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .stat { font-size: 1.1em; }
        .stat strong { color: #fff; }
        #dungeon-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #dungeon, #message-log { margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #444; }
        #hand { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .card { background: #fdfdfd; border: 1px solid #999; border-radius: 8px; padding: 10px; cursor: pointer; width: 100px; text-align: center; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .card:hover { transform: translateY(-8px); box-shadow: 0 10px 15px rgba(0,0,0,0.4); }
        .card-face { font-size: 2.5em; font-weight: bold; }
        .card-info { font-size: 0.9em; }
        .card-type { display: block; font-weight: bold; margin-bottom: 5px; }
        .card-value { display: block; font-size: 0.8em; color: #555; }
        .spades .card-face, .clubs .card-face { color: #333; }
        .hearts .card-face { color: #d9534f; }
        .diamonds .card-face { color: #428bca; }
        .joker .card-face { color: #8a2be2; }
        .spades .card-type, .clubs .card-type { color: #333; }
        .hearts .card-type { color: #d9534f; }
        .diamonds .card-type { color: #428bca; }
        .joker .card-type { color: #8a2be2; }
        #message-log { min-height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.1em; color: var(--text-color); }
        
        /* Color Picker */
        .color-picker { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .color-swatch { width: 100%; height: 50px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .color-swatch:hover { border-color: #fff; }

        /* Rules Screen */
        #rules-content { padding: 10px; line-height: 1.6; }

        /* Game Over Screen Specifics */
        #game-over-screen {
            background-color: black; /* Specific black background for game over */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100; /* Ensure it's on top */
            opacity: 0; /* Start invisible for fade-in */
            visibility: hidden; /* Hide initially */
            transition: opacity 1s ease-in-out, visibility 1s; /* Fade-in effect */
        }
        #game-over-screen.active {
            opacity: 1; /* Fade in */
            visibility: visible;
        }
        #game-over-screen h2.game-over-title { /* Use a specific class for the h2 */
            color: red;
            font-size: 3.5em; /* Larger size */
            margin-bottom: 15px;
            border-bottom: none; /* Remove border from H2 */
            text-shadow: 0 0 10px red; /* Optional: add glow effect */
            animation: pulse 1.5s infinite alternate; /* Pulse animation */
        }
        #game-over-screen p.game-over-message { /* Use a specific class for the p */
            color: white; /* Contrast with red */
            font-size: 1.8em; /* Larger size */
            margin-bottom: 40px;
        }
        #game-over-screen .menu-container {
            margin-top: 20px;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }
        
        /* Game Clear Screen Specifics */
        #game-clear-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent black background */
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease-in-out, visibility 1s;
        }
        #game-clear-screen.active {
            opacity: 1;
            visibility: visible;
        }
        #game-clear-screen h2 {
            color: gold; /* Gold color for victory */
            font-size: 3.5em;
            margin-bottom: 15px;
            border-bottom: none;
            text-shadow: 0 0 10px gold;
            animation: pulse-gold 1.5s infinite alternate;
        }
        #game-clear-screen p {
            color: white;
            font-size: 1.8em;
            margin-bottom: 40px;
        }
        @keyframes pulse-gold {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }
    </style>
</head>
<body>

    <!-- Title Screen -->
    <div id="title-screen" class="screen active">
        <h1>ãƒˆãƒ©ãƒ³ãƒ—ãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h1>
        <div class="menu-container">
            <button class="menu-btn" onclick="runGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button class="menu-btn btn-secondary" onclick="showScreen('settings-screen')">è¨­å®š</button>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settings-screen" class="screen">
        <h2>è¨­å®š</h2>
        <div class="menu-container">
            <button class="menu-btn" onclick="showScreen('color-picker-screen')">èƒŒæ™¯è‰²ã‚’å¤‰æ›´</button>
            <button class="menu-btn" onclick="showScreen('rules-screen')">ãƒ«ãƒ¼ãƒ«</button>
            <button class="menu-btn btn-secondary" onclick="showScreen('title-screen')">æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- Rules Screen -->
    <div id="rules-screen" class="screen">
        <h2>ãƒ«ãƒ¼ãƒ«</h2>
        <div id="rules-content">
            <p>ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’ç”Ÿãå»¶ã³ã€å±±æœ­ã‚’å…¨ã¦å¼•ãåˆ‡ã‚Œã°ã‚¯ãƒªã‚¢ã§ã™ã€‚</p>
            <ul>
                <li><strong>â™ /â™£ (æ•µ):</strong> æˆ¦ã£ã¦å€’ã—ã¾ã™ã€‚æ­¦å™¨ãŒãªã„ã‹ã€æ•µã®æ”»æ’ƒåŠ›ãŒæ­¦å™¨ã‚ˆã‚Šé«˜ã„ã¨ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¾ã™ã€‚æˆ¦é—˜å¾Œã€æ­¦å™¨ã¯å£Šã‚Œã¾ã™ã€‚</li>
                <li><strong>â™¥ (å›å¾©):</strong> HPã‚’å›å¾©ã—ã¾ã™ã€‚</li>
                <li><strong>â™¦ (æ­¦å™¨):</strong> è£…å‚™ã—ã¦æ•µã‹ã‚‰ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é˜²ãã¾ã™ã€‚</li>
                <li><strong>ğŸƒ (ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼):</strong> å ´ã«ã‚ã‚‹ä»–ã®ã‚«ãƒ¼ãƒ‰ã‚’å…¨ã¦æ¶ˆã—å»ã‚Šã¾ã™ã€‚</li>
                <li><strong>ãƒãƒªã‚¬ãƒ³:</strong> HPã®åŠåˆ†ã‚’ã‚³ã‚¹ãƒˆã«ã€å ´ã®æ‰‹æœ­ã‚’å…¨ã¦å¼•ãç›´ã—ã¾ã™ã€‚</li>
            </ul>
        </div>
        <div class="menu-container">
            <button class="menu-btn btn-secondary" onclick="showScreen('settings-screen')">æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- Color Picker Screen -->
    <div id="color-picker-screen" class="screen">
        <h2>èƒŒæ™¯è‰²ã‚’é¸æŠ</h2>
        <div class="color-picker">
            <div class="color-swatch" style="background-color: red;" onclick="changeBackgroundColor('red')"></div>
            <div class="color-swatch" style="background-color: blue;" onclick="changeBackgroundColor('blue')"></div>
            <div class="color-swatch" style="background-color: yellow;" onclick="changeBackgroundColor('yellow')"></div>
            <div class="color-swatch" style="background-color: green;" onclick="changeBackgroundColor('green')"></div>
            <div class="color-swatch" style="background-color: orange;" onclick="changeBackgroundColor('orange')"></div>
            <div class="color-swatch" style="background-color: purple;" onclick="changeBackgroundColor('purple')"></div>
            <div class="color-swatch" style="background-color: white;" onclick="changeBackgroundColor('white')"></div>
            <div class="color-swatch" style="background-color: black;" onclick="changeBackgroundColor('black')"></div>
            <div class="color-swatch" style="background-color: gray;" onclick="changeBackgroundColor('gray')"></div>
        </div>
        <div class="menu-container">
            <button class="menu-btn btn-secondary" onclick="showScreen('settings-screen')">æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div id="game-container">
            <h1>ãƒˆãƒ©ãƒ³ãƒ—ãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h1>
            <div id="player-stats"></div>
            <div id="dungeon">
                <div id="dungeon-header">
                    <h2>ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h2>
                    <button id="mulligan-btn" class="btn" onclick="mulligan()">ãƒãƒªã‚¬ãƒ³</button>
                </div>
                <div id="hand"></div>
            </div>
            <div id="message-log"></div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="screen">
        <h2 class="game-over-title">GAME OVER......</h2>
        <p class="game-over-message">æ”»ç•¥ãªã‚‰ãš</p>
        <div class="menu-container">
            <button class="menu-btn" onclick="runGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
            <button class="menu-btn btn-secondary" onclick="showScreen('title-screen')">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
    </div>

    <!-- Game Clear Screen -->
    <div id="game-clear-screen" class="screen">
        <h2>ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼</h2>
        <p style="text-align: center; margin-bottom: 20px;">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’æ”»ç•¥ã—ã¾ã—ãŸã€‚</p>
        <div class="menu-container">
            <button class="menu-btn" onclick="runGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
            <button class="menu-btn btn-secondary" onclick="showScreen('title-screen')">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
    </div>


<script>
const suits = ['â™ ', 'â™£', 'â™¥', 'â™¦'];
const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
const MAX_HP = 20;

// Game State
let playerHp;
let equippedWeapon;
let deck;
let hand;
let gameMessage;

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
        // Hide game over screen explicitly if not active, to reset animation
        if (screen.id === 'game-over-screen') {
            screen.style.opacity = '0';
            screen.style.visibility = 'hidden';
        }
        if (screen.id === 'game-clear-screen') {
            screen.style.opacity = '0';
            screen.style.visibility = 'hidden';
        }
    });

    const targetScreen = document.getElementById(screenId);
    if (screenId === 'game-over-screen' || screenId === 'game-clear-screen') {
        // For game over/clear screens, manage opacity and visibility for fade effect
        targetScreen.style.visibility = 'visible';
        setTimeout(() => {
            targetScreen.classList.add('active');
        }, 10); // Small delay to trigger transition
    } else {
        targetScreen.classList.add('active');
    }
}

// Function to convert hex to RGB (for luminance check)
function hexToRgb(hex) {
    var r = parseInt(hex.substring(1, 3), 16);
    var g = parseInt(hex.substring(3, 5), 16);
    var b = parseInt(hex.substring(5, 7), 16);
    return { r, g, b };
}

function changeBackgroundColor(color) {
    const root = document.querySelector(':root');
    // Determine if the chosen background color is dark or light to set appropriate text/container colors
    // Simple luminance check: (R*0.299 + G*0.587 + B*0.114) to determine perceived brightness
    let isDark = false;
    if (['black', 'purple', '#2c2c2c', 'gray', 'blue'].includes(color)) { // Explicitly dark colors
        isDark = true;
    } else if (color.startsWith('#')) {
        const rgb = hexToRgb(color);
        if (rgb) {
            isDark = (rgb.r * 0.299 + rgb.g * 0.587 + rgb.b * 0.114) < 186;
        }
    } else { // Handle named colors
        // For simplicity, assume other named colors like red, yellow, green, orange, white are light
        // A more robust solution would involve a color conversion library or a comprehensive lookup table
        if (['white', 'yellow', 'red', 'green', 'orange'].includes(color)) {
            isDark = false;
        }
    }
    
    root.style.setProperty('--bg-color', color);
    root.style.setProperty('--text-color', isDark ? '#f0f0f0' : '#333');
    root.style.setProperty('--container-bg', isDark ? '#383838' : '#e0e0e0'); // Slightly lighter container for light backgrounds
    root.style.setProperty('--border-color', isDark ? '#555' : '#ccc');
}


function getCardValue(rank) {
    if (rank === 'A') return 1;
    if (rank === 'J') return 11;
    if (rank === 'Q') return 12;
    if (rank === 'K') return 13;
    return parseInt(rank, 10);
}

function createDeck() {
    const newDeck = [];
    for (const suit of suits) {
        for (const rank of ranks) {
            newDeck.push({ suit, rank, value: getCardValue(rank) });
        }
    }
    newDeck.push({ suit: 'ğŸƒ', rank: 'JOKER', value: 0 }); // Add one joker
    return newDeck;
}

function shuffleDeck(deckToShuffle) {
    for (let i = deckToShuffle.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deckToShuffle[i], deckToShuffle[j]] = [deckToShuffle[j], deckToShuffle[i]];
    }
}

function runGame() {
    startGame();
    showScreen('game-screen');
}

function startGame() {
    playerHp = MAX_HP;
    equippedWeapon = null;
    deck = createDeck();
    shuffleDeck(deck);
    hand = [];
    gameMessage = 'ãƒ©ãƒ“ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®å†’é™ºã¸ã‚ˆã†ã“ãï¼';
    drawCards(); // This also renders the game
}

function drawCards() {
    if (deck.length === 0 && hand.length === 0) {
        showScreen('game-clear-screen');
        return;
    }
    const cardsNeeded = 4 - hand.length;
    const cardsToDraw = Math.min(cardsNeeded, deck.length);
    for (let i = 0; i < cardsToDraw; i++) {
        hand.push(deck.pop());
    }
    renderGame();
}

function renderGame() {
    const statsDiv = document.getElementById('player-stats');
    let weaponText = 'ãªã—';
    if (equippedWeapon) {
        weaponText = `${equippedWeapon.suit}${equippedWeapon.rank} (æ”»æ’ƒåŠ› ${equippedWeapon.value})`;
    }
    statsDiv.innerHTML = `
        <div class="stat">HP: <strong>${playerHp}/${MAX_HP}</strong></div>
        <div class="stat">æ­¦å™¨: <strong>${weaponText}</strong></div>
        <div class="stat">å±±æœ­æ®‹ã‚Š: <strong>${deck.length}æš</strong></div>
    `;

    const handDiv = document.getElementById('hand');
    handDiv.innerHTML = '';
    hand.forEach((card, index) => {
        const cardDiv = document.createElement('div');
        let typeText = '';
        let valueText = '';
        
        switch (card.suit) {
            case 'â™ ': case 'â™£':
                cardDiv.classList.add(card.suit === 'â™ ' ? 'spades' : 'clubs');
                typeText = 'æ•µ'; valueText = `æ”»æ’ƒåŠ›: ${card.value}`; break;
            case 'â™¥':
                cardDiv.classList.add('hearts');
                typeText = 'å›å¾©'; valueText = `å›å¾©é‡: ${card.value}`; break;
            case 'â™¦':
                cardDiv.classList.add('diamonds');
                typeText = 'æ­¦å™¨'; valueText = `æ”»æ’ƒåŠ›: ${card.value}`; break;
            case 'ğŸƒ':
                cardDiv.classList.add('joker');
                typeText = 'ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼'; valueText = 'å ´ã®ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆã™'; break;
        }

        cardDiv.classList.add('card');
        cardDiv.innerHTML = `
            <div class="card-face">${card.suit}${card.rank === 'JOKER' ? '' : card.rank}</div>
            <div class="card-info"><span class="card-type">${typeText}</span><span class="card-value">${valueText}</span></div>
        `;
        cardDiv.onclick = () => playCard(index);
        handDiv.appendChild(cardDiv);
    });

    document.getElementById('message-log').textContent = gameMessage;
}

function playCard(cardIndex) {
    if (playerHp <= 0 || !hand[cardIndex]) return;
    const card = hand.splice(cardIndex, 1)[0];

    switch (card.suit) {
        case 'â™ ': case 'â™£':
            let damage = card.value;
            if (equippedWeapon) {
                if (card.value <= equippedWeapon.value) {
                    damage = 0;
                    gameMessage = `${card.suit}${card.rank}(${card.value})ã‚’ç„¡å‚·ã§å€’ã—ãŸï¼`;
                } else {
                    damage = card.value - equippedWeapon.value;
                    gameMessage = `${card.suit}${card.rank}(${card.value})ã¨æˆ¦ã„ã€${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ...`;
                }
                gameMessage += ` æ­¦å™¨(${equippedWeapon.suit}${equippedWeapon.rank})ãŒå£Šã‚ŒãŸã€‚`;
                equippedWeapon = null;
            } else {
                gameMessage = `${card.suit}${card.rank}(${card.value})ã¨æˆ¦ã„ã€${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ...`;
            }
            playerHp -= damage;
            break;
        case 'â™¥':
            playerHp = Math.min(MAX_HP, playerHp + card.value);
            gameMessage = `${card.suit}${card.rank}(${card.value})ã‚’é£Ÿã¹ãŸã€‚HPãŒ${card.value}å›å¾©ã—ãŸã€‚`;
            break;
        case 'â™¦':
            gameMessage = `${card.suit}${card.rank}(${card.value})ã‚’è£…å‚™ã—ãŸã€‚`;
            equippedWeapon = card;
            break;
        case 'ğŸƒ':
            gameMessage = "ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã®åŠ¹æœã§å ´ã®ã‚«ãƒ¼ãƒ‰ãŒæ¶ˆãˆå»ã£ãŸï¼";
            hand = [];
            break;
    }

    if (playerHp <= 0) {
        playerHp = 0;
        showScreen('game-over-screen');
    } else {
        drawCards();
    }
}

function mulligan() {
    if (playerHp <= 0) return;
    if (deck.length < 4) {
        gameMessage = "å±±æœ­ãŒè¶³ã‚Šãªã„ã®ã§ãƒãƒªã‚¬ãƒ³ã§ãã¾ã›ã‚“ã€‚";
        renderGame();
        return;
    }

    const hpLost = Math.ceil(playerHp / 2);
    playerHp -= hpLost;
    gameMessage = `æ‰‹æœ­ã‚’äº¤æ›ã—ãŸã€‚HPãŒ${hpLost}æ¸›å°‘ã—ãŸã€‚`;
    
    if (playerHp <= 0) {
        playerHp = 0;
        showScreen('game-over-screen');
    } else {
        hand = [];
        drawCards();
    }
}

// Initial load
showScreen('title-screen');

</script>
</body>
</html>